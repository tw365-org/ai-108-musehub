/**
 * AI 108 MuseHub - Resilience Script
 */
let aiHeroes = [];
let currentPage = 1;
const itemsPerPage = 10;
const flags = { "TW": "üáπüáº", "US": "üá∫üá∏", "CN": "üá®üá≥", "FR": "üá´üá∑", "DE": "üá©üá™", "JP": "üáØüáµ", "UK": "üá¨üáß", "CA": "üá®üá¶", "AU": "üá¶üá∫", "SG": "üá∏üá¨", "AT": "üá¶üáπ", "IL": "üáÆüá±", "GE": "Ê†ºÈ≠Ø", "IN": "Âç∞", "LU": "Áõß", "IT": "ÊÑè", "RU": "‰øÑ" };

async function loadData() {
    const loadingEl = document.getElementById('loading');
    const gridEl = document.getElementById('toolsGrid');

    try {
        const response = await fetch('data.json?v=' + Date.now());
        if (!response.ok) throw new Error('Data load failed');
        aiHeroes = await response.json();
    } catch (error) {
        console.error("Critical: Fallback activated.", error);
        aiHeroes = [{ "id": 1, "name": "LMSYS (Èè°ÂÉèÁ´ô)", "url": "https://lmarena.ai/zh", "cat": "Â∞çË©±", "country": "US", "speed": 4 }];
    } finally {
        if (loadingEl) loadingEl.style.display = 'none';
        if (gridEl) gridEl.classList.remove('hidden');
        render();
    }
}

function probeLatency(url, id) {
    const start = performance.now();
    fetch(url, { mode: 'no-cors', cache: 'no-cache' }).then(() => {
        const end = performance.now();
        const latency = Math.round(end - start);
        const el = document.getElementById(`probe-${id}`);
        if (el) {
            el.innerText = `${latency}ms`;
            el.className = latency < 500 ? 'text-emerald-400' : 'text-orange-400';
        }
    }).catch(() => {
        const el = document.getElementById(`probe-${id}`);
        if (el) el.innerText = "N/A";
    });
}

function render() {
    const grid = document.getElementById('toolsGrid');
    if (!grid) return;
    grid.innerHTML = "";
    
    const search = document.getElementById('searchInput')?.value.toLowerCase() || "";
    const cat = document.getElementById('catFilter')?.value || "";
    
    const filtered = aiHeroes.filter(t => t.name.toLowerCase().includes(search) && (cat === "" || t.cat === cat));
    const paginated = filtered.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);

    paginated.forEach(tool => {
        const card = document.createElement('div');
        card.className = "muse-card p-7 rounded-3xl flex flex-col justify-between h-full border border-slate-800 bg-slate-900/40 backdrop-blur-md";
        card.innerHTML = `
            <div>
                <div class="flex justify-between items-center mb-6 text-[10px] font-bold text-violet-400 uppercase tracking-widest">
                    <span>${tool.cat}</span>
                    <span class="text-slate-500">${flags[tool.country] || tool.country}</span>
                </div>
                <h3 class="text-xl font-bold text-white mb-2 leading-tight">${tool.name}</h3>
                <div class="text-[10px] font-mono mt-4" id="probe-${tool.id}">Probing...</div>
            </div>
            <div class="mt-10">
                <a href="${tool.url}" target="_blank" class="block w-full text-center bg-violet-600 hover:bg-violet-500 py-3 rounded-2xl text-sm font-bold text-white transition shadow-lg shadow-violet-900/20">Êé¢Á¥¢ÈùàÊÑü</a>
            </div>
        `;
        grid.appendChild(card);
        probeLatency(tool.url, tool.id);
    });
    renderPagination(filtered.length);
}

function renderPagination(total) {
    const pages = Math.ceil(total / itemsPerPage);
    const container = document.getElementById('pagination');
    if (!container) return;
    container.innerHTML = "";
    if (pages <= 1) return;
    for (let i = 1; i <= pages; i++) {
        const btn = document.createElement('button');
        btn.innerText = i;
        btn.className = `w-10 h-10 rounded-full border border-slate-800 text-xs ${i === currentPage ? 'bg-violet-600 text-white border-violet-600' : 'text-slate-500 hover:bg-slate-800'}`;
        btn.onclick = () => { window.scrollTo({top: 0, behavior: 'smooth'}); currentPage = i; render(); };
        container.appendChild(btn);
    }
}

// Èò≤ÂëÜÁõ£ËÅΩÂô®Ë®≠ÂÆö
const sInput = document.getElementById('searchInput');
const cFilter = document.getElementById('catFilter');
if (sInput) sInput.addEventListener('input', () => { currentPage = 1; render(); });
if (cFilter) cFilter.addEventListener('change', () => { currentPage = 1; render(); });

loadData();